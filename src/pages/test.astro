---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="mbti-test-card">
    <header class="mbti-header">
      <h1 class="mbti-title">MBTI性格特质测试</h1>
      <div class="mbti-subtitle">国际通用版MBTI人格测试(16人格)</div>
    </header>
    <section class="mbti-question-area">
      <div class="mbti-q-top">
        <span class="mbti-q-index" id="q-index">01 / 20</span>
        <div class="mbti-progress-bar-bg">
          <div class="mbti-progress-bar" id="progress-bar"></div>
        </div>
      </div>
      <div class="mbti-q-text" id="q-text"></div>
      <div class="mbti-options">
        <label class="mbti-option" id="labelA">
          <input type="radio" name="mbti-option" id="optionA" value="A" />
          <span class="mbti-option-text" id="optionA-text"></span>
        </label>
        <label class="mbti-option" id="labelB">
          <input type="radio" name="mbti-option" id="optionB" value="B" />
          <span class="mbti-option-text" id="optionB-text"></span>
        </label>
      </div>
    </section>
    <div class="mbti-nav-row">
      <button class="mbti-btn mbti-btn-prev" id="btn-prev">&lt;&lt; 上一题</button>
      <button class="mbti-btn mbti-btn-next" id="btn-next">下一题 &gt;&gt;</button>
    </div>

  </div>
</Layout>

<script type="module" client:load>
/**
 * 题库数据，20题，覆盖E/I、S/N、T/F、J/P四个维度
 * 每题A/B分别对应一个维度加分
 */
const questions = [
  { id: 1, text: "当你参加社交聚会时，你倾向于：", optionA: "与多数人交谈，包括陌生人。", optionB: "寻找熟悉的人或小团体进行深入交流。", dimensionA: "E", dimensionB: "I" },
  { id: 2, text: "你更喜欢：", optionA: "多样化和变化的生活。", optionB: "有规律和可预测的生活。", dimensionA: "N", dimensionB: "S" },
  { id: 3, text: "遇到问题时，你更依赖：", optionA: "逻辑分析。", optionB: "个人价值观和感受。", dimensionA: "T", dimensionB: "F" },
  { id: 4, text: "你做计划时：", optionA: "喜欢提前规划。", optionB: "更喜欢顺其自然。", dimensionA: "J", dimensionB: "P" },
  { id: 5, text: "你在新环境中：", optionA: "主动结识新朋友。", optionB: "等待别人来接近你。", dimensionA: "E", dimensionB: "I" },
  { id: 6, text: "你更信任：", optionA: "直觉和灵感。", optionB: "实际经验。", dimensionA: "N", dimensionB: "S" },
  { id: 7, text: "你更容易被：", optionA: "事实和数据说服。", optionB: "情感和故事打动。", dimensionA: "T", dimensionB: "F" },
  { id: 8, text: "你喜欢的工作方式：", optionA: "有明确目标和计划。", optionB: "灵活应变，随时调整。", dimensionA: "J", dimensionB: "P" },
  { id: 9, text: "你在团队中：", optionA: "喜欢带动气氛。", optionB: "更喜欢安静观察。", dimensionA: "E", dimensionB: "I" },
  { id: 10, text: "你更关注：", optionA: "未来的可能性。", optionB: "当前的现实。", dimensionA: "N", dimensionB: "S" },
  { id: 11, text: "你做决定时：", optionA: "更看重公平和原则。", optionB: "更看重人情和关系。", dimensionA: "T", dimensionB: "F" },
  { id: 12, text: "你面对突发事件时：", optionA: "喜欢有预案。", optionB: "相信自己能随机应变。", dimensionA: "J", dimensionB: "P" },
  { id: 13, text: "你更喜欢：", optionA: "热闹的聚会。", optionB: "安静的独处时光。", dimensionA: "E", dimensionB: "I" },
  { id: 14, text: "你获取信息时：", optionA: "关注整体和趋势。", optionB: "关注细节和事实。", dimensionA: "N", dimensionB: "S" },
  { id: 15, text: "你更容易：", optionA: "理性地表达观点。", optionB: "体贴地照顾他人感受。", dimensionA: "T", dimensionB: "F" },
  { id: 16, text: "你做事风格：", optionA: "喜欢按计划推进。", optionB: "喜欢灵活调整。", dimensionA: "J", dimensionB: "P" },
  { id: 17, text: "你在陌生场合：", optionA: "主动发言。", optionB: "倾向于倾听。", dimensionA: "E", dimensionB: "I" },
  { id: 18, text: "你更欣赏：", optionA: "创新和创意。", optionB: "实用和可靠。", dimensionA: "N", dimensionB: "S" },
  { id: 19, text: "你更倾向于：", optionA: "直接表达批评。", optionB: "委婉表达关切。", dimensionA: "T", dimensionB: "F" },
  { id: 20, text: "你面对任务时：", optionA: "喜欢列清单逐项完成。", optionB: "随时根据情况调整顺序。", dimensionA: "J", dimensionB: "P" },
];

// 状态管理
let current = 0;
const total = questions.length;
let answers = Array(total).fill(null);

// 尝试从 sessionStorage 恢复
if (typeof window !== 'undefined' && window.sessionStorage) {
  const saved = window.sessionStorage.getItem('mbti-answers');
  if (saved) {
    try { answers = JSON.parse(saved); } catch {}
  }
}

// 渲染题目
function render() {
  document.getElementById('q-index').textContent = `${String(current+1).padStart(2,'0')} / ${total}`;
  document.getElementById('q-text').textContent = questions[current].text;
  document.getElementById('optionA-text').textContent = `A. ${questions[current].optionA}`;
  document.getElementById('optionB-text').textContent = `B. ${questions[current].optionB}`;
  // 选项状态
  document.getElementById('optionA').checked = answers[current] === 'A';
  document.getElementById('optionB').checked = answers[current] === 'B';
  // 按钮状态
  document.getElementById('btn-prev').disabled = current === 0;
  document.getElementById('btn-prev').style.visibility = current === 0 ? 'hidden' : 'visible';
  const btnNext = document.getElementById('btn-next');
  btnNext.textContent = current === total-1 ? '查看结果' : '下一题 >>';
  // 进度条
  document.getElementById('progress-bar').style.width = `${((current+1)/total)*100}%`;
  // 选项高亮
  document.getElementById('labelA').classList.toggle('selected', answers[current] === 'A');
  document.getElementById('labelB').classList.toggle('selected', answers[current] === 'B');
}

document.getElementById('optionA').onclick = () => { answers[current] = 'A'; save(); render(); };
document.getElementById('optionB').onclick = () => { answers[current] = 'B'; save(); render(); };
// 选项点击，自动跳转下一题
document.getElementById('optionA').onclick = () => {
  answers[current] = 'A';
  save();
  if (current < total - 1) {
    current++;
  }
  render();
};
document.getElementById('optionB').onclick = () => {
  answers[current] = 'B';
  save();
  if (current < total - 1) {
    current++;
  }
  render();
};

// 上一题
document.getElementById('btn-prev').onclick = () => {
  if (current > 0) { current--; render(); }
};
// 下一题/提交
document.getElementById('btn-next').onclick = () => {
  if (!answers[current]) {
    alert('请选择一个选项后再继续');
    return;
  }
  if (current < total-1) {
    current++;
    render();
  } else {
    // 计算结果
    const dim = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };
    questions.forEach((q, idx) => {
      if (answers[idx] === 'A') dim[q.dimensionA]++;
      if (answers[idx] === 'B') dim[q.dimensionB]++;
    });
    const type = `${dim.E>=dim.I?'E':'I'}${dim.S>=dim.N?'S':'N'}${dim.T>=dim.F?'T':'F'}${dim.J>=dim.P?'J':'P'}`;
    window.sessionStorage.setItem('mbti-answers', JSON.stringify(answers));
    window.location.href = `/result?type=${type}`;
  }
};

// 保存答案
function save() {
  if (typeof window !== 'undefined' && window.sessionStorage) {
    window.sessionStorage.setItem('mbti-answers', JSON.stringify(answers));
  }
}

// 初始化
render();
</script>

<style is:global>
.mbti-test-card {
  max-width: 480px;
  margin: 40px auto 24px auto;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 4px 32px rgba(74,108,247,0.10);
  padding: 32px 28px 18px 28px;
  font-family: 'Helvetica Neue', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;
  position: relative;
}
.mbti-header {
  text-align: center;
  margin-bottom: 18px;
}
.mbti-title {
  font-size: 2.1rem;
  font-weight: 700;
  margin-bottom: 0.3rem;
  letter-spacing: 1px;
  color: #222;
}
.mbti-subtitle {
  font-size: 1.08rem;
  color: #8a8a8a;
  margin-bottom: 0.5rem;
}
.mbti-question-area {
  margin-bottom: 18px;
}
.mbti-q-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.mbti-q-index {
  font-size: 1.18rem;
  font-weight: 600;
  color: #4a6cf7;
  letter-spacing: 1px;
}
.mbti-progress-bar-bg {
  flex: 1;
  height: 6px;
  background: #e7eaf3;
  border-radius: 3px;
  margin-left: 18px;
  overflow: hidden;
}
.mbti-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #4a6cf7 0%, #bc52ee 100%);
  border-radius: 3px;
  transition: width 0.3s;
}
.mbti-q-text {
  font-size: 1.13rem;
  color: #222;
  margin-bottom: 18px;
  font-weight: 500;
  min-height: 2.2em;
}
.mbti-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.mbti-option {
  display: flex;
  align-items: center;
  font-size: 1.05rem;
  color: #333;
  cursor: pointer;
  border-radius: 8px;
  padding: 8px 10px;
  transition: background 0.18s;
  border: 1.5px solid transparent;
  user-select: none;
}
.mbti-option input[type=\"radio\"] {
  accent-color: #4a6cf7;
  margin-right: 10px;
  width: 18px;
  height: 18px;
}
.mbti-option.selected {
  background: #f0f4ff;
  border-color: #4a6cf7;
  color: #4a6cf7;
  font-weight: 600;
}
.mbti-nav-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 22px 0 10px 0;
}
.mbti-btn {
  border: none;
  border-radius: 8px;
  background: #f5f6fa;
  color: #4a6cf7;
  font-size: 1.08rem;
  font-weight: 600;
  padding: 10px 22px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s;
  box-shadow: 0 2px 8px rgba(74,108,247,0.04);
}
.mbti-btn:disabled,
.mbti-btn[disabled] {
  background: #f0f0f0;
  color: #bdbdbd;
  cursor: not-allowed;
}
.mbti-btn:hover:not(:disabled) {
  background: #e7eaf3;
  color: #bc52ee;
}
.mbti-note {
  margin-top: 18px;
  text-align: center;
  color: #b0b0b0;
  font-size: 0.93rem;
  line-height: 1.6;
}
.mbti-note-line {
  margin-bottom: 2px;
}
@media (max-width: 600px) {
  .mbti-test-card {
    max-width: 99vw;
    padding: 16px 4vw 10px 4vw;
    margin: 16px auto 10px auto;
  }
  .mbti-title {
    font-size: 1.3rem;
  }
  .mbti-subtitle {
    font-size: 0.98rem;
  }
  .mbti-q-index {
    font-size: 1rem;
  }
  .mbti-q-text {
    font-size: 1rem;
  }
  .mbti-btn {
    font-size: 1rem;
    padding: 10px 0;
    width: 48vw;
    min-width: 110px;
  }
}
</style>